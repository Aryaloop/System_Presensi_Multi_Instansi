import{b as G,r,u as M,j as e,S as j,a as y}from"./index-CMRaJyvN.js";const F=x=>{const o=new Date(x);return new Date(o.toLocaleString("en-US",{timeZone:"Asia/Jakarta"}))};function R(){const x=G(),o=new Date,[g,k]=r.useState(!1),[i,_]=r.useState({lat:"",long:""}),[w,C]=r.useState(!1),[S,L]=r.useState("Menunggu Lokasi..."),[f,N]=r.useState(!1),{data:v,isLoading:P}=M({queryKey:["lokasiShift"],queryFn:async()=>(await y.get("/api/user/lokasi-shift")).data,retry:1}),n=v?.perusahaan,l=v?.shift,{data:I}=M({queryKey:["kehadiran",o.getMonth()+1,o.getFullYear()],queryFn:async()=>(await y.get(`/api/user/kehadiran?bulan=${o.getMonth()+1}&tahun=${o.getFullYear()}`)).data.data||[]}),K=I||[],A=()=>new Promise((a,t)=>{if(!navigator.geolocation)return t("Browser tidak mendukung GPS.");navigator.geolocation.getCurrentPosition(s=>{const{latitude:d,longitude:c}=s.coords;_({lat:d.toFixed(6),long:c.toFixed(6)}),C(!0),a({latitude:d,longitude:c})},s=>t(s.message),{enableHighAccuracy:!0,timeout:1e4})});r.useEffect(()=>{A().catch(()=>{})},[]),r.useEffect(()=>{if(n&&i.lat&&i.long){const a=111e3*(i.lat-n.latitude),t=111e3*(i.long-n.longitude),s=Math.sqrt(a*a+t*t);L(s<=n.radius_m?"‚úÖ Dalam Area":`‚ùå Luar Area (${Math.floor(s)}m)`)}},[n,i]),r.useEffect(()=>{if(!l?.jam_masuk){N(!1);return}const a=()=>{const s=new Date,[d,c]=l.jam_masuk.split(":"),m=new Date;m.setHours(parseInt(d),parseInt(c),0,0),N(s<m)};a();const t=setInterval(a,6e4);return()=>clearInterval(t)},[l]);const D=async a=>{k(!0);try{if(!n)throw new Error("Data lokasi kantor belum dimuat.");const{latitude:t,longitude:s}=await A(),d=111e3*(t-n.latitude),c=111e3*(s-n.longitude),m=Math.sqrt(d*d+c*c);if(m>n.radius_m)throw new Error(`Anda berada di luar radius kantor (${Math.floor(m)}m).`);const B={tipe:a,latitude:t,longitude:s},E=await y.post("/api/user/absen",B);j.fire("Berhasil",E.data.message,"success"),x.invalidateQueries({queryKey:["kehadiran"]})}catch(t){const s=t.response?.data?.message||t.message||"Gagal Absen";j.fire("Gagal",s,"error")}finally{k(!1)}},b=K.find(a=>F(a.created_at).toDateString()===o.toDateString()),u=b?.jam_masuk!=null,p=b?.jam_pulang!=null,h=b?.status==="IZIN",q=l?.jam_masuk?`${l.jam_masuk} WIB`:"(Non-Shift)",$=l?.jam_pulang?`${l.jam_pulang} WIB`:"(Non-Shift)";return P?e.jsx("div",{className:"p-4 bg-white rounded border",children:"‚è≥ Memuat data kantor..."}):e.jsxs("div",{className:"bg-white rounded-xl border shadow-sm",children:[e.jsxs("div",{className:"p-4 border-b flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:"üìç Absen GPS"}),e.jsx("span",{className:`text-xs font-medium px-2 py-1 rounded ${w?"bg-green-100 text-green-700":"bg-red-100 text-red-600"}`,children:w?"GPS Aktif":"Cari Lokasi..."})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("button",{onClick:()=>D("MASUK"),disabled:g||h||u||f,className:`h-14 rounded-lg font-semibold text-white transition flex flex-col items-center justify-center 
              ${g||h||u||f?"bg-gray-400 cursor-not-allowed":"bg-emerald-600 hover:bg-emerald-700 active:scale-95"}`,children:[e.jsx("span",{className:"text-sm",children:u?"‚úÖ Sudah Absen Masuk":f?"‚è≥ Belum Jam Masuk":"Tekan untuk Absen Masuk"}),e.jsxs("span",{className:"text-xs opacity-80 font-normal mt-0.5",children:["Jadwal: ",q]})]}),e.jsxs("button",{onClick:()=>{j.fire({title:"Konfirmasi Pulang",text:"Yakin ingin absen pulang?",icon:"question",showCancelButton:!0,confirmButtonText:"Ya"}).then(a=>a.isConfirmed&&D("KELUAR"))},disabled:g||h||!u||p,className:`h-14 rounded-lg font-semibold text-white transition flex flex-col items-center justify-center
              ${g||h||!u||p?"bg-gray-400 cursor-not-allowed":"bg-indigo-600 hover:bg-indigo-700 active:scale-95"}`,children:[e.jsx("span",{className:"text-sm",children:p?"‚úÖ Sudah Pulang":"Absen Pulang"}),e.jsxs("span",{className:"text-xs opacity-80 font-normal mt-0.5",children:["Jadwal: ",$]})]})]}),e.jsxs("div",{className:"mt-5 bg-slate-50 border rounded-lg p-3 text-xs text-gray-600 space-y-2",children:[e.jsxs("div",{className:"flex justify-between border-b pb-2",children:[e.jsxs("span",{children:["üè¢ ",n?.nama_perusahaan||"Kantor"]}),e.jsx("span",{className:S.includes("Dalam")?"text-green-600 font-bold":"text-red-500 font-bold",children:S})]}),e.jsx("div",{children:n?.alamat||"Alamat belum disetting"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{value:i.lat,readOnly:!0,className:"w-1/2 p-1 border rounded bg-white text-center",placeholder:"Lat"}),e.jsx("input",{value:i.long,readOnly:!0,className:"w-1/2 p-1 border rounded bg-white text-center",placeholder:"Long"})]})]})]})]})}export{R as C};
